{{define "in"}}-p {{.protocol}} -m {{.protocol}} -s {{.address}} --dport {{.port}} -j ACCEPT{{end}}
{{define "out"}}-p {{.protocol}} -m {{.protocol}} -d {{.address}} --dport {{.port}} -j ACCEPT{{end}}
*filter
:INPUT ACCEPT
:FORWARD ACCEPT
:OUTPUT ACCEPT
-A INPUT -m state --state ESTABLISHED -j ACCEPT
-A INPUT -m state --state RELATED -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
<% @new_resource.keys.each do |k| -%>
{{if exists "<%= k %>"}}{{range jsonArray (getv "<%= k %>")}}-A <%= k.split('/').last.upcase %> {{if eq .direction "in"}}{{template "in" .}}{{else}}{{template "out" .}}{{end}}
{{end}}{{end}}
<% end -%>
COMMIT
